function h(){const e=document.createElement("div");e.style.position="fixed",e.style.top="0",e.style.right="0",e.style.width="380px",e.style.height="100vh",e.style.zIndex="2147483647",e.style.pointerEvents="auto";const o=e.attachShadow({mode:"open"}),t=document.createElement("div");t.style.all="initial",o.appendChild(t);const c=document.createElement("style");c.textContent=`
    .panel{box-shadow:0 0 0 1px rgba(0,0,0,.06),0 12px 16px rgba(0,0,0,.12);background:#fff;border-radius:8px;margin:12px;pointer-events:auto;display:flex;flex-direction:column;height:calc(100vh - 24px)}
    .header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eee;font-family:system-ui;-webkit-font-smoothing:antialiased}
    .title{font-weight:600}
    .body{padding:12px;overflow:auto;flex:1}
    .row{margin-bottom:8px}
    .btn{background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 10px;cursor:pointer}
    .btn.secondary{background:#e5e7eb;color:#111}
    .item{border:1px solid #eee;border-radius:6px;padding:8px;margin-bottom:8px}
    .item-title{font-weight:600;font-size:13px}
    .item-link{font-size:12px;color:#666}
    .item-desc{font-size:12px;color:#444}
  `,t.appendChild(c);const n=document.createElement("div");n.className="panel";const i=document.createElement("div");i.className="header";const r=document.createElement("div");r.className="title",r.textContent="网站助手";const d=document.createElement("div"),a=document.createElement("button");a.className="btn secondary",a.textContent="关闭",a.onclick=()=>{e.remove()};const l=document.createElement("button");l.className="btn",l.textContent="打开侧边栏",l.onclick=()=>{chrome.runtime.sendMessage({type:"OPEN_SIDEPANEL"})},d.appendChild(l),d.appendChild(a),i.appendChild(r),i.appendChild(d);const s=document.createElement("div");return s.className="body",n.appendChild(i),n.appendChild(s),t.appendChild(n),document.documentElement.appendChild(e),{host:e,body:s}}async function f(){const e=await chrome.storage.local.get(["assistantFeed","assistantFeedRecords"]),o=Array.isArray(e.assistantFeed)?e.assistantFeed:[],t=Array.isArray(e.assistantFeedRecords)?e.assistantFeedRecords:[],c=location.origin,n=t.find(r=>r&&typeof r.site=="string"&&c.includes(new URL(r.site,c).host));return o.length>0?o:n?n.items||[]:[]}function x(e,o,t){e.innerHTML="";const c=document.createElement("div");if(c.className="row",t&&(c.textContent="意图: "+t),e.appendChild(c),!o||o.length===0){const n=document.createElement("div");n.textContent="暂无功能项",e.appendChild(n);return}o.forEach(n=>{const i=document.createElement("div");i.className="item";const r=document.createElement("div");r.className="item-title",r.textContent=n.title;const d=document.createElement("div");d.className="item-link",d.textContent=n.link;const a=document.createElement("div");a.className="item-desc",a.textContent=n.description;const l=document.createElement("div"),s=document.createElement("button");s.className="btn",s.textContent="打开",s.onclick=()=>{n.link&&(location.href=n.link)};const u=document.createElement("button");u.className="btn secondary",u.textContent="设为意图",u.onclick=()=>{chrome.runtime.sendMessage({type:"SET_INTENT",intent:n.title})},l.appendChild(s),l.appendChild(u),i.appendChild(r),i.appendChild(d),i.appendChild(a),i.appendChild(l),e.appendChild(i)})}async function m(e){const{body:o}=h(),t=await f();x(o,t,e)}chrome.runtime.onMessage.addListener((e,o,t)=>{if(e&&e.type==="RUN_FEATURE")return m().catch(()=>{}),t({ok:!0}),!0;if(e&&e.type==="SHOW_INTENT")return m(e.intent).catch(()=>{}),t({ok:!0}),!0;if(e&&e.type==="CHAT_RUN")return y(e).then(c=>t({ok:!0,result:c})).catch(()=>t({ok:!1})),!0});function b(e){const o=e.getBoundingClientRect();return o.width>0&&o.height>0}function p(){const e=["button","a[href]",'[role="button"]','input[type="submit"]','input[type="button"]'];for(const o of e){const t=Array.from(document.querySelectorAll(o)).filter(b);if(t.length>0)return t[0]}return null}async function y({mode:e,text:o}){if(e==="Query"){const t={title:document.title,url:location.href,links:document.querySelectorAll("a").length,buttons:document.querySelectorAll("button").length,inputs:document.querySelectorAll("input,select,textarea").length};return`标题: ${t.title}
URL: ${t.url}
链接: ${t.links} 按钮: ${t.buttons} 输入: ${t.inputs}`}if(e==="Tap"){const t=p();if(!t)return"未找到可点击元素";t.scrollIntoView({behavior:"smooth",block:"center"});const{body:c}=h(),n=document.createElement("div");n.className="item";const i=document.createElement("div");i.className="item-title",i.textContent="已定位到一个可点击元素";const r=document.createElement("div");return r.className="item-link",r.textContent=t.innerText||t.getAttribute("href")||"",n.appendChild(i),n.appendChild(r),c.innerHTML="",c.appendChild(n),"已定位元素"}if(e==="Action"){const t=p();return t?(t.click(),"已尝试点击第一个按钮"):"未找到可点击元素"}if(e==="Assert"){const t=(o||"").trim();return t?document.querySelector(t)?"断言通过：元素存在":"断言失败：元素不存在":"请提供选择器"}return"已记录请求"}
