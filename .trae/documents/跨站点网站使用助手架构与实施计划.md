## 目标
- 提供跨站点通用的“网站使用助手”，支持浏览器扩展等形态。
- 通过对话界面理解意图，跳转到目标页面并引导操作，或自动执行流程。
- 自动化支持两种模式：可见的页面操作与关键接口直连（例如新建员工）。

## 形态选型
- 浏览器扩展（推荐）：Chrome/Edge/Firefox Manifest v3，具备最优的跨站点注入、权限与UI形态（Popup/Side Panel）。
- 可选形态：
  - Userscript（Tampermonkey）：轻量但权限与更新管理较弱。
  - Bookmarklet：适配性弱，调试困难。
  - 桌面自动化（Playwright）：适合批量/离线自动化，不适合用户交互场景。

## 总体架构
- 后台（Service Worker）：站点适配加载、意图解析、流程编排、接口调用、数据持久化。
- 内容脚本（Content Scripts）：页面元素识别、高亮与引导、可见自动化执行器。
- UI层：
  - Popup/侧边栏对话面板：意图输入、结果展示、模式切换（引导/可见自动化/API直连）。
  - 浮层（Overlay）：步骤提示、元素高亮、进度与日志。
- 站点适配（Adapter Loader）：按域名/规则加载站点描述文件（SDF），统一流程定义。
- 意图引擎（Intent Engine）：将自然语言或命令映射为站点功能（feature）。
- 执行引擎：
  - Action Runner（UI）：click/fill/select/wait/assert 等页面动作，可见且可回放。
  - API Runner：以 fetch 调用关键接口，处理认证/CSRF/重试/幂等。
- 存储：Dexie/IndexedDB，缓存适配、最近操作、日志与最小配置。
- 通信：扩展消息总线（后台↔内容脚本↔UI）。

## 站点描述文件（SDF）设计
- 格式：JSON/YAML，支持远程托管与版本化。
- 基本结构：
  - `siteId`、`domains`、`auth`（登录页、检测规则、令牌/CSRF配置）。
  - `features[]`：每个功能包含 `id`、`name`、`intents[]`、`mode[]`、`inputs[]`、`navigation[]`、`uiSteps[]`、`apiSteps[]`、`validators[]`。
- 步骤语义：
  - UI步骤：`type`（click/fill/select/wait/assert）、`selector`、`value`/`dataKey`、`timeout`、`retry`、`visibility`。
  - API步骤：`method`、`url`、`headers`、`body`（模板变量）、`auth`（cookie/header/token）、`expect`（status/body字段）。
- 容错与选择器：多选择器备选、相似度匹配、显式 `waitFor` 与 `assert` 保障稳定性。
- 权限与安全：字段级白名单、敏感数据脱敏、仅站点域名范围的权限声明。
- 示例（新建员工，简化）：
```
{
  "siteId": "acme-hr",
  "domains": ["hr.acme.com"],
  "auth": {"loginUrl": "/login", "csrf": {"cookie": "csrf_token", "header": "X-CSRF"}},
  "features": [
    {
      "id": "create_employee",
      "name": "新建员工",
      "intents": ["新建员工", "添加员工"],
      "mode": ["guided", "visible_automation", "api"],
      "inputs": [
        {"key": "name", "type": "string", "required": true},
        {"key": "dept", "type": "string", "required": true}
      ],
      "navigation": [
        {"type": "url", "value": "/employees/new"}
      ],
      "uiSteps": [
        {"type": "fill", "selector": "input[name='name']", "dataKey": "name"},
        {"type": "select", "selector": "select[name='dept']", "dataKey": "dept"},
        {"type": "click", "selector": "button.submit"},
        {"type": "assert", "selector": ".toast-success"}
      ],
      "apiSteps": [
        {"method": "POST", "url": "/api/employees", "body": {"name": "${name}", "dept": "${dept}"}, "auth": "cookie"}
      ]
    }
  ]
}
```

## 对话与执行界面
- 对话面板：提示词建议、参数收集、目标功能确认与模式切换。
- 页面引导：在目标页逐步提示并高亮控件，支持“我来”和“一键执行”。
- 日志与回放：每步状态、失败原因、重试按钮与可视轨迹回放。

## 自动化模式
- 引导模式（Guided）：用户手动执行，助手仅定位与提示，零副作用，适合首次使用。
- 可见自动化（Visible Automation）：逐步点击/填充/提交，所有动作可观察与暂停。
- 接口直连（API）：直接调用关键接口并在页面展示结果，适合批量与稳定流程。
- 模式切换：在对话面板中切换，并可设站点/功能级默认策略。

## 认证与安全
- 登录态复用：同域 Cookie/Session，必要时读取 CSRF 与注入请求头。
- Token 管理：站点适配声明令牌来源，不持久化明文敏感信息。
- 权限声明：最小权限 Manifest（`activeTab`、指定域名 `host_permissions`）。
- 隐私：本地优先存储、可导出/清除日志与数据。

## 跨站点通用性
- 适配注册：按 `domains` 自动匹配与加载 SDF，缺省降级为通用引导模式。
- 远程更新：SDF 版本化与签名校验，热更新与回滚。
- 复用能力：通用动作库（等待、容错、相似匹配、数据模板）。

## 技术栈
- TypeScript + Manifest v3。
- UI：React/Svelte + Tailwind（或站点内样式隔离的 Shadow DOM）。
- 存储：Dexie/IndexedDB。
- 测试：Jest + 站点模拟页，E2E 以 Playwright 验证选择器与流程稳健性。

## 开发与测试流程
- 站点样例：搭建最小 HR 样例页用于端到端验证三种模式。
- 选择器稳健性：多备选与断言必备；失败自动收集快照与诊断信息。
- API 校验：模拟 CSRF、鉴权失败、幂等与重试策略。

## 里程碑
- M1（2–3周）：扩展骨架、对话面板、SDF 解析、引导模式、单一站点“新建员工”贯通。
- M2（2–3周）：可见自动化执行器、日志回放、容错与多站点适配加载。
- M3（2–3周）：接口直连模式、令牌/CSRF管理、批量操作与远程适配更新。

## 交付物
- 扩展项目（含后台、内容脚本、UI面板、Overlay）。
- SDF 规范与校验器、示例站点适配包。
- 测试用例与模拟站点、使用说明与安全声明。

## 后续扩展
- LLM 意图增强（本地规则先行，LLM 可插拔）。
- 团队共享适配库与发布渠道、版本签名与审计。
- 数据字段字典与多语言支持、可视化适配器编辑器。